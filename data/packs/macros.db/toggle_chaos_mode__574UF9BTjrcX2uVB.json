{
	"_id": "574UF9BTjrcX2uVB",
	"_key": "!macros!574UF9BTjrcX2uVB",
	"author": "9x0Fx3xohMgaCVFR",
	"command": "// Toggle Chaos Mode\n// Author: PrototypeESBU\n// v1.2\n// Description: Enables Chaos Mode where initiative is re-rolled every round.\n// -----------------------------------------------------\nconst displayChatMessage = true;\n// -----------------------------------------------------\n//------------------------------------------------------\n\n// Find existing chaos mode hooks\nlet hookId = 0;\nif (Hooks.events.combatRound) {\n    for (const event of Hooks.events.combatRound) {\n        if (event.fn.name === \"chaosMode\") hookId = event.id;\n    }\n}\n\nif (hookId){\n    // Disable chaos mode\n    Hooks.off('combatRound', hookId);\n    ui.notifications.error(\"Chaos Mode Disabled\");\n}\nelse {\n    // Enabled chaos mode\n    Hooks.on('combatRound', chaosMode);\n    ui.notifications.info(\"Chaos Mode Enabled\");\n}\n\nasync function chaosMode(){\n    //reset initiative\n    await game.combat.resetAll();\n\n    // Iterate over Combatants, performing an initiative roll for each\n    const updates = [];\n    const combatants = [];\n    for ( const combatant of game.combat.combatants ) {\n        if ( !combatant?.isOwner ) continue;\n        // Produce an initiative roll for the Combatant\n        const roll = combatant.getInitiativeRoll();\n        await roll.evaluate();\n        updates.push({_id: combatant.id, initiative: roll.total});\n        combatants.push({name:combatant.name, initiative: roll.total})\n    }\n    if ( !updates.length ) return;\n\n    // Update multiple combatants\n    await game.combat.updateEmbeddedDocuments(\"Combatant\", updates);\n\n    //set new starting player\n    await game.combat.update({turn: 0});\n\n    // Craft a chat message\n    if (displayChatMessage) {\n        let message = `<h3 class=\"larger\">Initiative Rolls</h3>`;\n        for ( const combatant of combatants.sort((a,b) => b.initiative - a.initiative)) {\n            message = message.concat(`<div class=\"flexrow\"><span>${combatant.name}</span><span>${combatant.initiative}</span></div>`);\n        }\n        ChatMessage.create({flavor: `Chaos Mode (Round ${game.combat.round})`, content: `<div class=\"shadowdark\">${message}</div>`});\n    }\n}",
	"folder": "FhCSCTkWnoWL3Q0A",
	"img": "icons/svg/terror.svg",
	"name": "Toggle Chaos Mode",
	"scope": "global",
	"type": "script"
}
